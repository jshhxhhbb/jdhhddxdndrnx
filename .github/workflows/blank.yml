name: Android Emulator (Guacamole + Fast & Stable)

on:
  workflow_dispatch:
    inputs:
      timeout_minutes:
        description: 'How long to keep emulator alive (max 360)'
        required: true
        default: '120'

jobs:
  emulator:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJson(inputs.timeout_minutes == '' && '360' || inputs.timeout_minutes) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space (optional but recommended)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Enable KVM
        run: |
          sudo mkdir -p /etc/udev/rules.d
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666"' | sudo tee /etc/udev/rules.d/99-kvm.rules
          sudo udevadm control --reload-rules && sudo udevadm trigger

      - name: Start Android Emulator with Guacamole (Fast & Mobile-Friendly)
        run: |
          docker run -d \
            --name android-emulator \
            --device /dev/kvm \
            -p 8080:8080 \
            -e DEVICE="pixel_7" \
            -e ANDROID_SDK_VERSION=34 \
            -e RAM_SIZE=4096 \
            -e HEAP_SIZE=512 \
            -e LOCALE="ja_JP" \
            aladin8877/docker-android-emulator:latest

          echo "Waiting for emulator and Guacamole to fully boot..."
          sleep 90  # 通常70〜90秒で完全に立ち上がる（超速）

      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/

      - name: Create Cloudflare Tunnel to Guacamole
        id: tunnel
        run: |
          echo "Starting tunnel to Guacamole (port 8080)..."
          timeout 300 cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          
          # Wait until URL appears
          for i in {1..60}; do
            URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' tunnel.log | head -1)
            if [[ -n "$URL" ]]; then
              echo "Success! Access URL: $URL"
              echo "url=$URL" >> $GITHUB_OUTPUT
              break
            fi
            sleep 5
          done

          if [[ -z "$URL" ]]; then
            echo "Tunnel timeout"
            cat tunnel.log
            exit 1
          fi

      - name: Keep workflow alive
        run: |
          echo "Emulator is running! Access URL:"
          echo "${{ steps.tunnel.outputs.url }}"
          echo "This session will stay alive for up to ${{ inputs.timeout_minutes || 360 }} minutes."
          sleep ${{ (inputs.timeout_minutes == '' && 360 || inputs.timeout_minutes) * 60 }}
