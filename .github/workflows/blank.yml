name: Android Emulator with Web Access via noVNC

on: workflow_dispatch  # Trigger manually to start the emulator session

jobs:
  emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Adjust as needed, max 360 minutes for GitHub Actions

    steps:
      - name: Checkout repository (optional)
        uses: actions/checkout@v4

      - name: Enable KVM for hardware acceleration
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Docker Android Emulator with noVNC
        run: |
          docker run -d -p 6080:6080 \
            -e EMULATOR_DEVICE="Samsung Galaxy S10" \
            -e WEB_VNC=true \
            --device /dev/kvm \
            --name android-container \
            budtmo/docker-android:emulator_11.0
          
          # Wait for the emulator to boot (adjust sleep if needed)
          echo "Waiting for emulator to start..."
          sleep 120
          
          # Optional: Check status
          docker exec android-container adb devices

      - name: Install cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/

      - name: Start Cloudflare Tunnel
        run: |
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          sleep 10  # Wait for tunnel to establish
          TUNNEL_URL=$(grep -o 'https://.*trycloudflare.com' tunnel.log)
          echo "Access the emulator via noVNC at: $TUNNEL_URL"

      - name: Keep the job running for interaction
        run: |
          echo "Emulator is running. Access the Cloudflare tunnel URL from the logs to connect via browser."
          echo "The workflow will timeout after the set duration."
          sleep 3600  # Keep alive for 1 hour; adjust as needed
