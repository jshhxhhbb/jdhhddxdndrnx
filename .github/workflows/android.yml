# .github/workflows/desktop.yml
name: ğŸš€ Web Desktop (noVNC - localhost.run)

on:
  workflow_dispatch:  # æ‰‹å‹•èµ·å‹•

jobs:
  start-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6æ™‚é–“ã§è‡ªå‹•çµ‚äº†ï¼ˆGitHubåˆ¶é™å¯¾å¿œï¼‰

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y xfce4 xfce4-goodies tightvncserver websockify novnc firefox openssh-client jq

      - name: Setup VNC and noVNC
        run: |
          # VNCãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã§ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ç¢ºä¿ï¼‰
          mkdir -p ~/.vnc
          VNC_PASS=$(openssl rand -base64 12)
          echo "=== VNC ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ¥ç¶šæ™‚å¿…é ˆï¼‰ ==="
          echo "VNC Password: $VNC_PASS"
          echo "====================================="
          echo $VNC_PASS | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          # VNCã‚µãƒ¼ãƒãƒ¼èµ·å‹•
          vncserver :1 -geometry 1280x720 -depth 24 &
          sleep 5

          # noVNCèµ·å‹•ï¼ˆãƒãƒ¼ãƒˆ6080ï¼‰
          websockify --web=/usr/share/novnc/ 6080 localhost:5901 &

          echo "VNC_PASS=$VNC_PASS" >> $GITHUB_ENV

      - name: Expose via localhost.run (No Account Needed)
        run: |
          # localhost.runã§ãƒãƒ¼ãƒˆ6080ã‚’å…¬é–‹ï¼ˆSSHã‚³ãƒãƒ³ãƒ‰ã§å³HTTPS URLç”Ÿæˆï¼‰
          # èƒŒæ™¯å®Ÿè¡Œã—ã¦URLå–å¾—ï¼ˆ5ç§’å¾…æ©Ÿï¼‰
          ssh -R 80:localhost:6080 nokey@localhost.run -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -N &
          SSH_PID=$!
          sleep 5

          # URLå–å¾—ï¼ˆlocalhost.runã¯å…¬é–‹å¾Œã€curlã§ç¢ºèªå¯èƒ½ã ãŒç°¡æ˜“çš„ã«å›ºå®šãƒ‘ã‚¿ãƒ¼ãƒ³ä½¿ç”¨ã€‚å®Ÿéš›ã¯ãƒ­ã‚°ç›£è¦–ï¼‰
          # æ³¨æ„: localhost.runã®URLã¯ãƒ©ãƒ³ãƒ€ãƒ ã€‚åˆå›æ¥ç¶šã§ç”Ÿæˆã•ã‚Œã‚‹ã®ã§ã€ãƒ­ã‚°ã§ç¢ºèªæ¨å¥¨
          PUBLIC_URL="https://$(curl -s ifconfig.me).localhost.run/vnc.html"  # ç°¡æ˜“ä¾‹ï¼ˆå®Ÿéš›ã¯å‹•çš„ï¼‰
          echo "ğŸš€ ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—èµ·å‹•ï¼ï¼ˆ6æ™‚é–“ã§çµ‚äº†ï¼‰"
          echo ""
          echo "ğŸ“º noVNC URLï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãï¼‰:"
          echo "https://$(hostname -I | awk '{print $1}').localhost.run/vnc.html"  # å‹•çš„ãƒ›ã‚¹ãƒˆä½¿ç”¨ï¼ˆèª¿æ•´å¿…è¦ï¼‰
          echo "   â€»åˆå›ã‚¢ã‚¯ã‚»ã‚¹ã§URLå®‰å®šåŒ–ã€‚ãƒ­ã‚°ã§ç¢ºèª"
          echo ""
          echo "ğŸ” VNCãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${VNC_PASS}"
          echo ""
          echo "âš ï¸ URLã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç§˜å¯†ã«ï¼ä»–äººå…±æœ‰NG"
          echo "SSH_PID=$SSH_PID" >> $GITHUB_ENV

      - name: Keep alive for 6 hours
        run: |
          # SSHãƒˆãƒ³ãƒãƒ«ç¶­æŒ
          wait $SSH_PID
          sleep 6h  # ãƒˆãƒ³ãƒãƒ«å¾…æ©Ÿ + è¿½åŠ æ™‚é–“
