# .github/workflows/desktop.yml
name: ğŸš€ Web Desktop (noVNC - Cloudflare Tunnel)

on:
  workflow_dispatch:  # æ‰‹å‹•èµ·å‹•

jobs:
  start-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6æ™‚é–“ã§è‡ªå‹•çµ‚äº†

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup cloudflared
        uses: AnimMouse/setup-cloudflared@v2  # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸è¦ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      - name: Install dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y xfce4 xfce4-goodies tightvncserver novnc firefox jq

      - name: Setup VNC and noVNC
        run: |
          # VNCãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
          mkdir -p ~/.vnc
          VNC_PASS=$(openssl rand -base64 12)
          echo "=== VNC ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ¥ç¶šæ™‚å¿…é ˆï¼‰ ==="
          echo "VNC Password: $VNC_PASS"
          echo "====================================="
          echo $VNC_PASS | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          # VNCã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
          vncserver :1 -geometry 1280x720 -depth 24 &
          VNC_PID=$!
          sleep 5

          # noVNCèµ·å‹•ï¼ˆãƒãƒ¼ãƒˆ6080ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
          mkdir -p /tmp/novnc-logs
          nohup websockify --web=/usr/share/novnc/ 6080 localhost:5901 > /tmp/novnc-logs/websockify.log 2>&1 &
          NOVNC_PID=$!

          echo "VNC_PASS=$VNC_PASS" >> $GITHUB_ENV
          echo "VNC_PID=$VNC_PID" >> $GITHUB_ENV
          echo "NOVNC_PID=$NOVNC_PID" >> $GITHUB_ENV

      - name: Expose via Cloudflare Tunnel (No Account Needed)
        id: tunnel
        run: |
          # Cloudflare Tunnelèµ·å‹•ï¼ˆHTTPã€ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ãƒ©ãƒ³ãƒ€ãƒ URLç”Ÿæˆï¼‰
          nohup cloudflared tunnel --http 0.0.0.0:6080 --no-autoupdate --loglevel info > /tmp/cloudflared.log 2>&1 &
          CLOUDFLARE_PID=$!

          # ãƒˆãƒ³ãƒãƒ«URLå–å¾—ï¼ˆãƒ­ã‚°ã‹ã‚‰jqã§æŠ½å‡ºã€5ç§’å¾…æ©Ÿï¼‰
          sleep 5
          while [ -z "$PUBLIC_URL" ]; do
            PUBLIC_URL=$(tail -f /tmp/cloudflared.log 2>/dev/null | grep -o 'https://.*\.trycloudflare\.com' | head -n1 || echo "")
            sleep 2
          done

          # URLãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç¨€ï¼‰
          if [ -z "$PUBLIC_URL" ]; then
            PUBLIC_URL=$(curl -s https://api.trycloudflare.com/get-random-tunnel | jq -r '.url' 2>/dev/null || echo "https://manual-check-logs.trycloudflare.com")
          fi

          echo "ğŸš€ ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—èµ·å‹•ï¼ï¼ˆ6æ™‚é–“ã§çµ‚äº†ï¼‰"
          echo ""
          echo "ğŸ“º noVNC URLï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãï¼‰:"
          echo "$PUBLIC_URL/vnc.html"
          echo ""
          echo "ğŸ” VNCãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${VNC_PASS}"
          echo ""
          echo "âš ï¸ URLã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç§˜å¯†ã«ï¼ä»–äººå…±æœ‰NG"
          echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV
          echo "CLOUDFLARE_PID=$CLOUDFLARE_PID" >> $GITHUB_ENV

      - name: Keep alive for 6 hours
        if: always()
        run: |
          # ãƒ—ãƒ­ã‚»ã‚¹ç¶­æŒï¼ˆkillã›ãšsleepã®ã¿ã€çµ‚äº†æ™‚ã«ActionsãŒè‡ªå‹•killï¼‰
          echo "ãƒˆãƒ³ãƒãƒ«PID: ${CLODFLARE_PID} ã‚’ç¶­æŒä¸­..."
          sleep 6h

      - name: Cleanup on exit
        if: always()
        run: |
          # çµ‚äº†æ™‚ã«ãƒ—ãƒ­ã‚»ã‚¹killï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å®Ÿè¡Œï¼‰
          if [ ! -z "${VNC_PID}" ]; then kill ${VNC_PID} || true; fi
          if [ ! -z "${NOVNC_PID}" ]; then kill ${NOVNC_PID} || true; fi
          if [ ! -z "${CLOUDFLARE_PID}" ]; then kill ${CLOUDFLARE_PID} || true; fi
          vncserver -kill :1 || true
          echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
