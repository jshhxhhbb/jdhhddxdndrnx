name: 'ðŸ“± Mobile Optimized VS Code'

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'VS Codeãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ç©ºãªã‚‰èªè¨¼ãªã—)'
        required: false
        default: ''

jobs:
  vscode:
    timeout-minutes: 360
    runs-on: ubuntu-latest

    steps:
      - name: 'Check out repository'
        uses: actions/checkout@v4

      - name: 'Install Quick Tools'
        run: |
          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ä¸¦åˆ—åŒ–ãƒ»ç°¡ç•¥åŒ–
          curl -fsSL https://code-server.dev/install.sh | sh -s -- --method=standalone &
          sudo curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
          wait
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: 'Launch & Extract URL'
        id: tunnel
        run: |
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
          if [ -n "${{ github.event.inputs.password }}" ]; then
            export AUTH_TYPE="--auth password"
            export PASSWORD="${{ github.event.inputs.password }}"
          else
            export AUTH_TYPE="--auth none"
          fi

          # code-server èµ·å‹•
          code-server --bind-addr 127.0.0.1:8080 $AUTH_TYPE --disable-telemetry > /dev/null 2>&1 &

          # Cloudflare Tunnel èµ·å‹•
          cloudflared tunnel --url http://127.0.0.1:8080 --no-autoupdate > /tmp/cf.log 2>&1 &

          # URLãŒãƒ­ã‚°ã«å‡ºã‚‹ã¾ã§é«˜é€Ÿãƒ«ãƒ¼ãƒ—ã§å¾…æ©Ÿ
          echo "Waiting for URL..."
          for i in {1..20}; do
            URL=$(grep -o 'https://.*\.trycloudflare\.com' /tmp/cf.log | head -n 1)
            if [ -n "$URL" ]; then
              echo "url=$URL" >> $GITHUB_OUTPUT
              
              # ã‚¹ãƒžãƒ›ã§è¦‹ã‚„ã™ã„ã‚ˆã†ã«Job Summaryã«å‡ºåŠ›
              echo "## ðŸš€ VS Code Ready!" >> $GITHUB_STEP_SUMMARY
              echo "[ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦VS Codeã‚’é–‹ã]($URL)" >> $GITHUB_STEP_SUMMARY
              echo "---" >> $GITHUB_STEP_SUMMARY
              echo "- **URL:** \`$URL\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Password:** \`${{ github.event.inputs.password || 'ãªã—' }}\`" >> $GITHUB_STEP_SUMMARY
              break
            fi
            sleep 1
          done

      - name: 'Keep Alive'
        if: steps.tunnel.outputs.url != ''
        run: |
          echo "Session active for 6 hours..."
          sleep 21600
