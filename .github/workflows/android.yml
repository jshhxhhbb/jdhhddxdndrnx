# .github/workflows/ubuntu-desktop.yml
name: Ubuntu Desktop (Pinggy Ultra Low Latency Tunnel)

on:
  workflow_dispatch:

jobs:
  ubuntu-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Desktop + VNC + SSH
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tightvncserver firefox openssh-client dbus-x11

      - name: Set VNC Password (12345678)
        run: |
          mkdir -p ~/.vnc
          echo '12345678' | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      - name: Create xstartup for XFCE
        run: |
          cat > ~/.vnc/xstartup <<'EOF'
          #!/bin/bash
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          startxfce4 &
          EOF
          chmod +x ~/.vnc/xstartup

      - name: Start VNC Server (極低遅延設定)
        run: |
          vncserver :1 -geometry 1920x1080 -depth 16
          sleep 5

      - name: Install noVNC + 極限低遅延モバイル最適化
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          cat > ~/noVNC/index.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Ubuntu Desktop - Pinggy Ultra Low Latency</title>
            <meta http-equiv="refresh" content="0; url=vnc.html?autoconnect=true&resize=scale&quality=4&compression=1&cursor=arrow&show_dot=false">
            <style>
              body { margin:0; background:#000; color:#0f0; font-family:system-ui; text-align:center; padding-top:30vh; }
              .box { background:#111; padding:20px; border-radius:15px; display:inline-block; border:2px solid #0f0; }
            </style>
          </head>
          <body>
            <div class="box">
              <h2>超低遅延接続中…</h2>
              <p>パスワード → 12345678<br>
              スマホでも完全フィット＆ヌルヌル動作保証<br>
              5～10秒待って下記のURLを開いてください</p>
            </div>
          </body>
          </html>
          EOF

      - name: Start noVNC proxy
        run: |
          ~/noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 0.0.0.0:6080 &

      - name: ★★★ Pinggy Tunnel起動 → URLがここに表示されます ★★★
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════"
          echo "    極低遅延Pinggyトンネル起動中…（5～15秒待機）"
          echo "    パスワードは 12345678 です"
          echo "    ↓↓↓ 下に https://xxxxxx.a.pinggy.link が出たら即アクセス ↓↓↓"
          echo "    （スマホでもPCでも過去最高のヌルヌル体験になります）"
          echo "════════════════════════════════════════════════════════════"
          echo ""
          ssh -p 443 -o StrictHostKeyChecking=no -R 0:localhost:6080 a.pinggy.io
