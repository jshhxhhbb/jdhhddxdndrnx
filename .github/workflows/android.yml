name: ğŸ–¥ï¸ Web Desktop Environment

on:
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚’ä¿æŒã™ã‚‹æ™‚é–“ï¼ˆåˆ†ï¼‰'
        required: true
        default: '30'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # Artifactsã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«å¿…è¦

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç’°å¢ƒã¨VNCé–¢é€£ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y lxde x11vnc websockify novnc xorg firefox

      - name: VNCç”¨ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        id: generate_password
        run: |
          # opensslã‚’ä½¿ã£ã¦å®‰å…¨ãªãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
          PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
          echo "VNC_PASSWORD=${PASSWORD}" >> $GITHUB_ENV
          echo "::add-mask::${PASSWORD}" # ãƒ­ã‚°ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œãªã„ã‚ˆã†ã«ãƒã‚¹ã‚¯

      - name: ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’èµ·å‹•
        run: |
          # /etc/X11/default-display-manager ãŒå­˜åœ¨ã—ãªã„å ´åˆã«å‚™ãˆã¦ä½œæˆ
          if [ ! -f /etc/X11/default-display-manager ]; then
            echo "/usr/sbin/lightdm" | sudo tee /etc/X11/default-display-manager
          fi
          # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§Xã‚µãƒ¼ãƒãƒ¼ã¨LXDEã‚’èµ·å‹•
          /usr/bin/startx &
          # ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãŒèµ·å‹•ã™ã‚‹ã¾ã§å°‘ã—å¾…ã¤
          sleep 15

      - name: VNCã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
        run: |
          # ç”Ÿæˆã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§VNCã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
          x11vnc -display :0 -forever -shared -passwd ${{ env.VNC_PASSWORD }} -rfbport 5900 &

      - name: noVNCãƒ—ãƒ­ã‚­ã‚·ã‚’èµ·å‹•
        run: |
          # noVNCã®WebSocketãƒ—ãƒ­ã‚­ã‚·ã‚’èµ·å‹•ã€‚ãƒãƒ¼ãƒˆ8080ã§å¾…ã¡å—ã‘ã€‚
          websockify --web /usr/share/novnc/ 8080 localhost:5900 &
          # ãƒ—ãƒ­ã‚­ã‚·ãŒèµ·å‹•ã™ã‚‹ã¾ã§å°‘ã—å¾…ã¤
          sleep 5

      - name: ãƒ©ãƒ³ãƒŠãƒ¼ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
        id: get_ip
        run: |
          # curlã‚’ä½¿ã£ã¦ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å–å¾—
          IP=$(curl -s ifconfig.me)
          echo "RUNNER_IP=${IP}" >> $GITHUB_ENV

      - name: æ¥ç¶šæƒ…å ±HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        run: |
          cat << EOF > connection.html
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <title>Desktop Connection Info</title>
              <style>
                  body { font-family: sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                  .container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
                  h1 { color: #333; }
                  p { font-size: 1.1rem; color: #555; }
                  .info { background-color: #e9ecef; padding: 1rem; border-radius: 5px; margin: 1rem 0; font-family: monospace; }
                  a { display: inline-block; margin-top: 1.5rem; padding: 0.8rem 1.5rem; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
                  a:hover { background-color: #0056b3; }
                  .warning { color: #d9534f; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ–¥ï¸ Webãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¸ã‚ˆã†ã“ãï¼</h1>
                  <p>ä»¥ä¸‹ã®æƒ…å ±ã‚’ä½¿ã£ã¦ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«æ¥ç¶šã—ã¦ãã ã•ã„ã€‚</p>
                  <p class="warning">âš ï¸ ã“ã®æ¥ç¶šæƒ…å ±ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã™ã‚‹ã¨ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚</p>
                  <div class="info">
                      <p><strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</strong> ${{ env.VNC_PASSWORD }}</p>
                  </div>
                  <a href="http://${{ env.RUNNER_IP }}:8080/vnc.html?autoconnect=true&password=${{ env.VNC_PASSWORD }}" target="_blank">Connect to Desktop</a>
              </div>
          </body>
          </html>
          EOF

      - name: æ¥ç¶šæƒ…å ±ã‚’Artifactsã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: desktop-connection-info
          path: connection.html
          retention-days: 1 # 1æ—¥å¾Œã«è‡ªå‹•å‰Šé™¤

      - name: æŒ‡å®šã—ãŸæ™‚é–“ã ã‘å®Ÿè¡Œã‚’ç¶­æŒ
        run: |
          echo "ğŸ•’ ${{ inputs.duration_minutes }} åˆ†é–“ã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚’ä¿æŒã—ã¾ã™ã€‚"
          sleep ${{ inputs.duration_minutes }}m
          echo "â° ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚"
