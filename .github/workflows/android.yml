name: 'Launch VS Code with Cloudflare Tunnel'

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'VS Codeのアクセスパスワード (未入力の場合はパスワードなし)'
        required: false
        default: ''

jobs:
  build:
    timeout-minutes: 360
    runs-on: ubuntu-latest

    steps:
      - name: 'リポジトリのチェックアウト'
        uses: actions/checkout@v4

      - name: 'code-serverのインストールとPATHの設定'
        run: |
          curl -fsSL https://code-server.dev/install.sh | sh -s -- --method=standalone
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: 'cloudflaredのインストールとセットアップ'
        uses: AnimMouse/setup-cloudflared@v2
        with:
          version: 'latest'

      - name: 'code-serverとCloudflare Tunnelの起動'
        id: tunnel
        run: |
          # パスワードの設定
          PASSWORD_ARG=""
          if [ -n "${{ github.event.inputs.password }}" ]]; then
            PASSWORD_ARG="--password ${{ github.event.inputs.password }}"
          else
            PASSWORD_ARG="--auth none"
          fi

          # バックグラウンドでcode-serverを起動
          code-server --bind-addr 127.0.0.1:8080 $PASSWORD_ARG --disable-telemetry &
          CODE_SERVER_PID=$!
          echo "Code-server PID: $CODE_SERVER_PID"

          # code-serverが起動するまで少し待機
          sleep 5

          # バックグラウンドでcloudflaredを起動し、ログをファイルに出力
          cloudflared tunnel --url http://127.0.0.1:8080 --logfile /tmp/cloudflared.log &
          CLOUDFLARED_PID=$!
          echo "Cloudflared PID: $CLOUDFLARED_PID"

          # ログファイルから公開URLを取得（最大30秒待機）
          TUNNEL_URL=""
          echo "Waiting for tunnel URL..."
          for i in {1..30}; do
            TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare\.com' /tmp/cloudflared.log | tail -n 1)
            if [[ -n "$TUNNEL_URL" ]]; then
              echo "Found tunnel URL: $TUNNEL_URL"
              break
            fi
            sleep 1
          done

          if [[ -z "$TUNNEL_URL" ]]; then
            echo "Failed to get tunnel URL."
            echo "--- Cloudflared Log ---"
            cat /tmp/cloudflared.log
            echo "--- Process Status ---"
            ps aux | grep -E "(code-server|cloudflared)" | grep -v grep
            exit 1
          fi

          # 次のステップで使えるようにURLをGITHUB_OUTPUTに保存
          echo "url=$TUNNEL_URL" >> $GITHUB_OUTPUT

      - name: '公開URLを表示'
        run: |
          echo "🚀 VS Codeにアクセス可能です！"
          echo "👉 公開URL: ${{ steps.tunnel.outputs.url }}"
          echo "⚠️ このセッションは6時間後に自動的に終了します。"
          echo "💡 パスワードを設定した場合は、アクセス時に求められます。"

      - name: '6時間キープアライブ'
        run: |
          echo "⏳ ワークフローを6時間（21600秒）実行し続けます..."
          sleep 21600
