name: Ubuntu Desktop (noVNC + localtunnel)

on:
  workflow_dispatch:  # 手動実行のみ

jobs:
  ubuntu-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 最大6時間（GitHubの制限）

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (for localtunnel)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install localtunnel
        run: npm install -g localtunnel

      - name: Install XFCE + TightVNC + Firefox
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tightvncserver dbus-x11 firefox gnome-icon-theme

      - name: Set VNC password (12345678)
        run: |
          mkdir -p ~/.vnc
          echo '12345678' | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      - name: Configure xstartup for XFCE
        run: |
          cat > ~/.vnc/xstartup << 'EOF'
          #!/bin/bash
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          export XDG_CURRENT_DESKTOP="XFCE"
          startxfce4 &
          EOF
          chmod +x ~/.vnc/xstartup

      - name: Start VNC Server
        run: |
          vncserver :1 -geometry 1440x900 -depth 24
          sleep 8

      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC

      - name: Start noVNC proxy
        run: |
          ~/noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 0.0.0.0:6080 &

      - name: Create Tunnel (localtunnel) ← これがURL表示
        run: |
          echo "=== 少し待ってから下記のURLにアクセスしてください ==="
          echo "パスワードは 12345678 です"
          lt --port 6080 --print-urls true
