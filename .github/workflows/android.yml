# ファイル名: .github/workflows/desktop.yml

name: 'Web-based Desktop Environment'

# このワークフローを手動で実行できるようにする
on:
  workflow_dispatch:

jobs:
  build:
    # Ubuntuの最新版で実行
    runs-on: ubuntu-latest

    steps:
      # 1. リポジトリのコードをチェックアウト（今回は不要だがお作法として）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. デスクトップ環境とVNCサーバー、および必要なフォントをインストール
      - name: Install Desktop and VNC
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends lxde-core tightvncserver websockify novnc xfonts-base xfonts-75dpi xfonts-100dpi

      # 3. VNCのパスワードを設定
      - name: Set VNC Password
        run: |
          mkdir -p ~/.vnc
          # GitHub Secretsからパスワードを読み込み、ファイルに保存
          echo "${{ secrets.VNC_PASSWORD }}" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      # 4. VNCサーバーを起動
      - name: Start VNC Server
        run: |
          # VNCサーバーをディスプレイ番号1、解像度1280x720で起動
          vncserver :1 -geometry 1280x720 -depth 24

      # 5. WebからVNCに接続するためのプロキシを起動
      - name: Start Websockify
        run: |
          # websockifyを起動し、Webブラウザからの接続(ポート6080)をVNCサーバー(ポート5901)に中継する
          # --web=/usr/share/novnc でnoVNCのWebクライアントも一緒に提供
          websockify --web=/usr/share/novnc 6080 localhost:5901 > websockify.log 2>&1 &

      # 6. Node.jsをインストール (localtunnelに必要)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 7. localtunnelをインストール
      - name: Install LocalTunnel
        run: npm install -g localtunnel

      # 8. localtunnelを起動して、Websockifyのポートを外部に公開
      - name: Start LocalTunnel
        run: |
          # バックグラウンドでlocaltunnelを実行し、URLをファイルに保存
          lt --port 6080 > tunnel_url.txt &
          # localtunnelが接続を確立するまで待機
          sleep 15

      # 9. 接続情報をGitHub Actionsのログに出力
      - name: Display Connection Info
        run: |
          # localtunnelが発行したURLを読み込む
          TUNNEL_URL=$(cat tunnel_url.txt | head -n 1)
          echo "-----------------------------------------"
          echo "🎉 デスクトップ環境が準備できました！"
          echo "-----------------------------------------"
          echo "📲 以下のURLをクリックして、ブラウザでデスクトップにアクセスしてください。"
          echo "URL: ${TUNNEL_URL}/vnc.html?autoconnect=true&resize=scale"
          echo "-----------------------------------------"
          echo "🔑 VNCパスワード: ${{ secrets.VNC_PASSWORD }}"
          echo "-----------------------------------------"
          echo "⚠️  このセッションは6時間後に自動的に終了します。"
          echo "⚠️  接続には数秒かかることがあります。"
          echo "-----------------------------------------"

      # 10. ワークフローが終了しないように待機
      - name: Keep workflow alive
        run: |
          # GitHub Actionsの最大実行時間（6時間 = 21600秒）までスリープし続ける
          sleep 21600
