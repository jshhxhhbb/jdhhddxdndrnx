# .github/workflows/ubuntu-desktop.yml
name: Ubuntu Desktop (noVNC + Cloudflare Tunnel)

on:
  workflow_dispatch:

jobs:
  ubuntu-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Desktop + VNC + Browser
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tightvncserver firefox dbus-x11

      - name: Set VNC Password (12345678)
        run: |
          mkdir -p ~/.vnc
          echo '12345678' | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      - name: Create xstartup for XFCE
        run: |
          cat > ~/.vnc/xstartup <<'EOF'
          #!/bin/bash
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          startxfce4 &
          EOF
          chmod +x ~/.vnc/xstartup

      - name: Start VNC Server
        run: |
          vncserver :1 -geometry 1440x900 -depth 24
          sleep 5

      - name: Install noVNC (最新版対応)
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          # 最新のnoVNCでは index.html が無いので、自動で vnc.html に飛ばす簡易ページを作成
          cat > ~/noVNC/index.html <<'EOF'
          <!DOCTYPE html>
          <html><head><meta http-equiv="refresh" content="0; url=vnc.html"></head>
          <body>Redirecting to noVNC...</body></html>
          EOF

      - name: Start noVNC websocket proxy
        run: |
          ~/noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 0.0.0.0:6080 &

      - name: Download cloudflared (最新版自動取得)
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O ~/cloudflared
          chmod +x ~/cloudflared

      - name: ★★★ ここにURLが出ます ★★★
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════"
          echo "　　５秒くらい待ってから下記のURLをブラウザで開いてください"
          echo "　　　　　　　　　　パスワード → 12345678"
          echo "════════════════════════════════════════════════════════════"
          echo ""
          ~/cloudflared tunnel --url http://localhost:6080
