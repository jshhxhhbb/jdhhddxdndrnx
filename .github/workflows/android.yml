name: 'Launch VS Code with Cloudflare Tunnel'

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'VS Codeのアクセスパスワード (未入力の場合はパスワードなし)'
        required: false
        default: ''

jobs:
  build:
    # 公開リポジトリの標準実行時間の上限が6時間なので、それに合わせる
    timeout-minutes: 360
    runs-on: ubuntu-latest

    steps:
      - name: 'リポジトリのチェックアウト'
        uses: actions/checkout@v4

      - name: 'code-serverのインストール'
        run: |
          curl -fsSL https://code-server.dev/install.sh | sh -s -- --method=standalone
          sudo mv ./code-server-*/code-server /usr/local/bin/code-server

      - name: 'cloudflaredのインストールとセットアップ'
        uses: AnimMouse/setup-cloudflared@v2
        with:
          # 最新版をインストール
          version: 'latest'

      - name: 'Cloudflare Tunnelの起動'
        id: tunnel
        run: |
          # パスワードの設定
          PASSWORD_ARG=""
          if [ -n "${{ github.event.inputs.password }}" ]; then
            PASSWORD_ARG="--password ${{ github.event.inputs.password }}"
          else
            PASSWORD_ARG="--auth none"
          fi

          # バックグラウンドでcode-serverを起動
          code-server --bind-addr 127.0.0.1:8080 $PASSWORD_ARG --disable-telemetry &

          # 一時的なトンネルを起動し、URLを取得
          # --url ではなく --run-token を使用する方が安定しているが、ここでは簡易的に --url を使用
          TUNNEL_URL=$(cloudflared tunnel --url http://127.0.0.1:8080 --logfile /tmp/cloudflared.log 2>&1 | grep -o 'https://.*\.trycloudflare\.com' | head -n 1)
          
          # URLが取得できるまで待機（最大30秒）
          for i in {1..30}; do
            TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare\.com' /tmp/cloudflared.log | tail -n 1)
            if [[ -n "$TUNNEL_URL" ]]; then
              break
            fi
            sleep 1
          done

          if [[ -z "$TUNNEL_URL" ]]; then
            echo "Failed to get tunnel URL"
            exit 1
          fi

          echo "url=$TUNNEL_URL" >> $GITHUB_OUTPUT
          echo "Tunnel URL: $TUNNEL_URL"

      - name: '公開URLを表示'
        run: |
          echo "🚀 VS Codeにアクセス可能です！"
          echo "👉 公開URL: ${{ steps.tunnel.outputs.url }}"
          echo "⚠️ このセッションは6時間後に自動的に終了します。"
          echo "💡 パスワードを設定した場合は、アクセス時に求められます。"

      - name: '6時間キープアライブ'
        run: |
          echo "⏳ ワークフローを6時間（21600秒）実行し続けます..."
          # 6時間 = 6 * 60分 * 60秒 = 21600秒
          sleep 21600
